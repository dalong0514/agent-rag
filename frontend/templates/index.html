<!DOCTYPE html>
<html>
<head>
    <title>LLM 个人知识工作台</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>LLM 个人知识工作台</h1>
        
        <div class="layout">
            <!-- 第一列：索引列表 -->
            <div class="index-section">
                <div class="section">
                    <h2>索引列表</h2>
                    <div id="indexList">
                        <div class="loading">加载中...</div>
                    </div>
                </div>
            </div>
    
            <!-- 第二列：输入部分 -->
            <div class="input-section">
                <div class="section">
                    <h2>查询文档</h2>
                    <form id="queryForm">
                        <textarea id="question" placeholder="输入你的问题..."></textarea>
                        <button type="submit" id="queryButton">查询</button>
                        <input type="number" id="similarityTopK" placeholder="输入similarity_top_k（默认12）" value="12">
                    </form>
                    <div id="queryResult"></div>
                </div>
    
                <div class="section">
                    <h2>与 LLM 聊天</h2>
                    <form id="chatForm">
                        <textarea id="chatQuestion" placeholder="输入你的问题..."></textarea>
                        <button type="submit" id="chatButton">发送</button>
                    </form>
                    <div id="chatResult"></div>
                </div>
            </div>
    
            <!-- 第三列：输出部分 -->
            <div class="output-section">
                <div class="section">
                    <h2>输出结果 <button id="copyButton" style="float: right;">复制结果</button></h2>
                    <div id="streamOutput" class="markdown-output"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // 切换按钮状态的函数
        function toggleButtonState(button, isLoading) {
            if (isLoading) {
                button.textContent = '请求中...';
                button.disabled = true;
            } else {
                button.textContent = '查询';
                button.disabled = false;
            }
        }
    
        // 修改流式输出部分
        function updateStreamOutput(content) {
            const outputElement = document.getElementById('streamOutput');
            outputElement.innerHTML = marked.parse(content);
            outputElement.scrollTop = outputElement.scrollHeight;
        }
    
        // 复制结果到剪贴板
        document.getElementById('copyButton').addEventListener('click', function() {
            const outputText = document.getElementById('streamOutput').textContent;
            if (outputText) {
                navigator.clipboard.writeText(outputText)
                    .then(function() {
                        alert('已复制到剪贴板');
                    })
                    .catch(function(error) {
                        alert('复制失败: ' + error);
                    });
            } else {
                alert('没有内容可复制');
            }
        });
    
        document.addEventListener('DOMContentLoaded', function() {
            // Function to load index names
            async function loadIndexNames() {
                try {
                    const response = await fetch('http://localhost:8001/get-index-names', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    });
                    
                    const data = await response.json();
                    const indexList = document.getElementById('indexList');
                    
                    if (data.status === 'success' && data.index_names.length > 0) {
                        indexList.innerHTML = data.index_names.map(name => 
                            `<div class="index-item">${name}</div>`
                        ).join('');
                        
                        // Add click event to index items
                        document.querySelectorAll('.index-item').forEach(item => {
                            item.addEventListener('click', function() {
                                // 切换选中状态
                                this.classList.toggle('selected');
                            });
                        });
    
                        // 绑定查询表单提交事件
                        document.getElementById('queryForm').addEventListener('submit', async function(e) {
                            e.preventDefault();
                            
                            const button = document.getElementById('queryButton');
                            toggleButtonState(button, true);
                            
                            const question = document.getElementById('question').value;
                            const similarityTopK = parseInt(document.getElementById('similarityTopK').value) || 12;
                            const selectedIndexes = Array.from(document.querySelectorAll('.index-item.selected'))
                                .map(item => item.textContent);
    
                            // 清空之前的输出
                            document.getElementById('streamOutput').textContent = '';
                            
                            try {
                                const response = await fetch('http://localhost:8001/query', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        question: question,
                                        index_names: selectedIndexes,
                                        similarity_top_k: similarityTopK,
                                        chat_record_dir: "/Users/Daglas/dalong.github/dalong.chatrecord/chatrecord-origin/"
                                    })
                                });
    
                                const reader = response.body.getReader();
                                const decoder = new TextDecoder();
                                let result = '';
    
                                while (true) {
                                    const { done, value } = await reader.read();
                                    if (done) break;
                                    
                                    const chunk = decoder.decode(value, { stream: true });
                                    result += chunk;
                                    
                                    updateStreamOutput(result);
                                    
                                    const outputElement = document.getElementById('streamOutput');
                                    outputElement.scrollTop = outputElement.scrollHeight;
                                }
                                
                            } catch (error) {
                                document.getElementById('streamOutput').textContent = `Error: ${error.message}`;
                            } finally {
                                toggleButtonState(button, false);
                            }
                        });
                    } else {
                        indexList.innerHTML = '<div class="no-data">没有可用的索引</div>';
                    }
                } catch (error) {
                    console.error('Error loading index names:', error);
                    document.getElementById('indexList').innerHTML = '<div class="error">加载索引列表失败</div>';
                }
            }
    
            // Load index names when page loads
            loadIndexNames();
        });
    </script>
</body>
</html>