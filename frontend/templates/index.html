<!DOCTYPE html>
<html>
<head>
    <title>LLM 个人知识工作台</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>LLM 个人知识工作台</h1>
        
        <div class="layout">
            <!-- 第一列：索引列表 -->
            <div class="index-section">
                <div class="section">
                    <h2>索引列表</h2>
                    <input type="text" id="indexFilter" placeholder="过滤索引..." class="filter-input">
                    <div id="indexList">
                        <div class="loading">加载中...</div>
                    </div>
                    <button id="manageIndexBtn" class="btn">管理索引列表</button>
                </div>
            </div>
    
            <!-- 第二列：输入部分 -->
            <div class="input-section">
                <div class="section">
                    <h2>RAG 查询文档</h2>
                    <form id="queryForm">
                        <textarea id="question" placeholder="输入你的问题..."></textarea>
                        <button type="submit" id="queryButton">发送</button>
                        <input type="number" id="similarityTopK" placeholder="输入similarity_top_k（默认10）" value="10">
                    </form>
                    <div id="queryResult"></div>
                </div>
    
                <div class="section">
                    <h2>与 LLM 聊天</h2>
                    <form id="chatForm">
                        <textarea id="chatQuestion" placeholder="输入你的问题..."></textarea>
                        <button type="submit" id="chatButton">发送</button>
                    </form>
                    <div id="chatResult"></div>
                </div>
            </div>
    
            <!-- 第三列：输出部分 -->
            <div class="output-section">
                <div class="section">
                    <h2>输出结果 <button id="copyButton" style="float: right;">复制结果</button></h2>
                    <div id="streamOutput" class="markdown-output"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加索引管理面板 -->
    <div id="indexManagementPanel" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>索引管理</h2>
            
            <div class="management-layout">
                <!-- 左侧：删除索引部分 -->
                <div class="delete-section">
                    <div class="header">
                        <button id="deleteIndexBtn" class="btn btn-danger">删除所选索引</button>
                    </div>
                    <div id="deleteIndexList"></div>
                </div>
    
                <!-- 右侧：添加索引部分 -->
                <div class="add-section">
                    <div class="form-group">
                        <label>索引名称:</label>
                        <input type="text" id="indexName" placeholder="输入索引名称">
                    </div>
                    <div class="form-group">
                        <label>索引类型:</label>
                        <select id="indexType">
                            <option value="basic">Basic</option>
                            <option value="sentence_window">Sentence Window</option>
                            <option value="automerging">Auto Merging</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Chunk Size:</label>
                        <input type="number" id="chunkSize" value="1024">
                    </div>
                    <div class="form-group">
                        <label>Chunk Overlap:</label>
                        <input type="number" id="chunkOverlap" value="200">
                    </div>
                    <div class="form-group">
                        <label>文件夹路径:</label>
                        <input type="text" id="folderPath" placeholder="输入文件夹绝对路径">
                    </div>
                    <div class="form-group">
                        <label>文件扩展名:</label>
                        <input type="text" id="fileExtension" placeholder="例如：md, txt">
                    </div>
                    <div class="form-group buttons-container">
                        <button id="selectIndividualFilesBtn" class="btn">选择文件</button>
                        <span id="selectedFilesInfo"></span>
                        <button id="addIndexBtn" class="btn btn-primary">添加索引</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // 切换按钮状态的函数
        function toggleButtonState(button, isLoading) {
            if (isLoading) {
                button.textContent = '请求中...';
                button.disabled = true;
            } else {
                button.textContent = '发送';
                button.disabled = false;
            }
        }
    
        // 修改流式输出部分
        let currentContent = ''; // 用于存储当前 content
        function updateStreamOutput(content) {
            currentContent = content; // 更新当前 content
            const outputElement = document.getElementById('streamOutput');
            outputElement.innerHTML = marked.parse(content);
            outputElement.scrollTop = outputElement.scrollHeight;
        }
    
        // 复制结果到剪贴板
        document.getElementById('copyButton').addEventListener('click', function() {
            if (currentContent) {
                navigator.clipboard.writeText(currentContent)
                    .then(function() {
                        alert('已复制到剪贴板');
                    })
                    .catch(function(error) {
                        alert('复制失败: ' + error);
                    });
            } else {
                alert('没有内容可复制');
            }
        });
    
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('indexManagementPanel');
            const closeBtn = document.querySelector('.close');
            const manageBtn = document.getElementById('manageIndexBtn');
            const deleteIndexBtn = document.getElementById('deleteIndexBtn');
            const addIndexBtn = document.getElementById('addIndexBtn');
            const selectFilesBtn = document.getElementById('selectFilesBtn');
            let selectedFiles = [];

            // 打开管理面板
            manageBtn.addEventListener('click', async function() {
                modal.style.display = 'block';
                await loadDeleteIndexList();
            });

            // 关闭管理面板
            closeBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });

            // 加载删除索引列表
            async function loadDeleteIndexList() {
                try {
                    const response = await fetch('http://localhost:8001/get-index-names', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    });
                    
                    const data = await response.json();
                    const deleteIndexList = document.getElementById('deleteIndexList');
                    
                    if (data.status === 'success' && data.index_names.length > 0) {
                        deleteIndexList.innerHTML = data.index_names.map(name => 
                            `<div class="index-item">${name}</div>`
                        ).join('');
                        
                        // 添加点击事件
                        document.querySelectorAll('#deleteIndexList .index-item').forEach(item => {
                            item.addEventListener('click', function() {
                                this.classList.toggle('selected-index');
                            });
                        });
                    } else {
                        deleteIndexList.innerHTML = '<div class="no-data">没有可用的索引</div>';
                    }
                } catch (error) {
                    console.error('Error loading index names:', error);
                    deleteIndexList.innerHTML = '<div class="error">加载索引列表失败</div>';
                }
            }

            // 删除索引
            deleteIndexBtn.addEventListener('click', async function() {
                // 保存原始按钮文本
                const originalText = this.textContent;
                
                // 切换按钮状态为加载中
                this.textContent = '删除中...';
                this.disabled = true;

                const selectedIndexes = Array.from(document.querySelectorAll('#deleteIndexList .selected-index'))
                    .map(item => item.textContent);
                
                if (selectedIndexes.length === 0) {
                    alert('请至少选择一个索引！');
                    // 恢复按钮状态
                    this.textContent = originalText;
                    this.disabled = false;
                    return;
                }

                try {
                    const response = await fetch('http://localhost:8001/delete-index', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            index_names: selectedIndexes
                        })
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        alert('删除成功！');
                        await loadIndexNames(); // 重新加载主界面索引列表
                        await loadDeleteIndexList(); // 重新加载管理面板的索引列表
                    } else {
                        alert('删除失败！');
                    }
                } catch (error) {
                    console.error('Error deleting indexes:', error);
                    alert('删除过程中发生错误！');
                } finally {
                    // 无论成功或失败，都恢复按钮状态
                    this.textContent = originalText;
                    this.disabled = false;
                }
            });

            // 添加选择文件按钮事件
            document.getElementById('selectIndividualFilesBtn').addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.multiple = true;
                
                input.addEventListener('change', function() {
                    if (this.files && this.files.length > 0) {
                        const folderPath = document.getElementById('folderPath').value;
                        selectedFiles = Array.from(this.files)
                            .filter(file => !file.name.startsWith('.')) // 过滤掉隐藏文件
                            .map(file => {
                                // 直接使用文件名，拼接完整路径
                                const fullPath = folderPath ? 
                                    `${folderPath.replace(/\/$/, '')}/${file.name}` : 
                                    file.name;
                                return fullPath.replace(/\\/g, '/'); // 确保路径使用正斜杠
                            });
                        console.log('Selected files:', selectedFiles);
                        document.getElementById('selectedFilesInfo').textContent = `已选择 ${selectedFiles.length} 个文件`;
                    } else {
                        console.log('No files selected');
                        document.getElementById('selectedFilesInfo').textContent = '未选择任何文件';
                    }
                });
                
                input.click();
            });

            // 添加索引
            addIndexBtn.addEventListener('click', async function() {
                // 保存原始按钮文本
                const originalText = this.textContent;
                
                // 切换按钮状态为加载中
                this.textContent = '添加中...';
                this.disabled = true;

                const requestBody = {
                    input_path: selectedFiles.length === 1 ? selectedFiles[0] : selectedFiles,
                    index_name: document.getElementById('indexName').value,
                    index_type: document.getElementById('indexType').value,
                    chunk_size: parseInt(document.getElementById('chunkSize').value),
                    chunk_overlap: parseInt(document.getElementById('chunkOverlap').value),
                    file_extension: document.getElementById('fileExtension').value || null
                };

                try {
                    const response = await fetch('http://localhost:8001/build-index', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Error details:', errorData);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.status === 'success') {
                        alert('索引添加成功！');
                        selectedFiles = [];
                        document.getElementById('selectedFilesInfo').textContent = '';
                        
                        // 添加重新加载索引列表的逻辑
                        await loadIndexNames(); // 重新加载主界面索引列表
                        await loadDeleteIndexList(); // 重新加载管理面板的索引列表
                    } else {
                        alert('索引添加失败！');
                    }
                } catch (error) {
                    console.error('Error adding index:', error);
                    alert(`添加索引过程中发生错误：${error.message}`);
                } finally {
                    // 无论成功或失败，都恢复按钮状态
                    this.textContent = originalText;
                    this.disabled = false;
                }
            });

            // Function to load index names
            // 修改 loadIndexNames 函数，将表单事件绑定移到函数外部
            async function loadIndexNames() {
                try {
                    const response = await fetch('http://localhost:8001/get-index-names', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    });
                    
                    const data = await response.json();
                    const indexList = document.getElementById('indexList');
                    
                    if (data.status === 'success' && data.index_names.length > 0) {
                        indexList.innerHTML = data.index_names.map(name => 
                            `<div class="index-item">${name}</div>`
                        ).join('');
                        
                        // Add click event to index items
                        document.querySelectorAll('.index-item').forEach(item => {
                            item.addEventListener('click', function() {
                                // 切换选中状态
                                this.classList.toggle('selected');
                            });
                        });
                    } else {
                        indexList.innerHTML = '<div class="no-data">没有可用的索引</div>';
                    }
                } catch (error) {
                    console.error('Error loading index names:', error);
                    document.getElementById('indexList').innerHTML = '<div class="error">加载索引列表失败</div>';
                }
            }

            // 绑定发送表单提交事件
            document.getElementById('queryForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const button = document.getElementById('queryButton');
                toggleButtonState(button, true);
                
                const question = document.getElementById('question').value;
                const similarityTopK = parseInt(document.getElementById('similarityTopK').value) || 12;
                const selectedIndexes = Array.from(document.querySelectorAll('.index-item.selected'))
                    .map(item => item.textContent);

                // 添加检查：如果 selectedIndexes 为空
                if (selectedIndexes.length === 0) {
                    alert('请至少选择一个索引！');
                    toggleButtonState(button, false);
                    return;
                }

                // 清空之前的输出
                document.getElementById('streamOutput').textContent = '';
                
                try {
                    const response = await fetch('http://localhost:8001/query', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            question: question,
                            index_names: selectedIndexes,
                            similarity_top_k: similarityTopK
                        })
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let result = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        result += chunk;
                        
                        updateStreamOutput(result);
                        
                        const outputElement = document.getElementById('streamOutput');
                        outputElement.scrollTop = outputElement.scrollHeight;
                    }
                    
                } catch (error) {
                    document.getElementById('streamOutput').textContent = `Error: ${error.message}`;
                } finally {
                    toggleButtonState(button, false);
                }
            });

            // Load index names when page loads
            loadIndexNames();

            // Chat with LLM 按钮事件
            document.getElementById('chatForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const button = document.getElementById('chatButton');
                toggleButtonState(button, true);
                
                const question = document.getElementById('chatQuestion').value;

                // 清空之前的输出
                document.getElementById('streamOutput').textContent = '';
                
                try {
                    const response = await fetch('http://localhost:8001/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            question: question
                        })
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let result = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        result += chunk;
                        
                        updateStreamOutput(result);
                        
                        const outputElement = document.getElementById('streamOutput');
                        outputElement.scrollTop = outputElement.scrollHeight;
                    }
                    
                } catch (error) {
                    document.getElementById('streamOutput').textContent = `Error: ${error.message}`;
                } finally {
                    toggleButtonState(button, false);
                }
            });

            // 添加索引过滤功能
            document.getElementById('indexFilter').addEventListener('input', function(e) {
                const filterText = e.target.value.toLowerCase();
                const indexItems = document.querySelectorAll('.index-item');
                
                indexItems.forEach(item => {
                    const indexName = item.textContent.toLowerCase();
                    if (indexName.includes(filterText)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        });
    </script>
</body>
</html>